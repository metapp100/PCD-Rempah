<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spice Lens - Deteksi Rempah Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* Warna Dasar dari Gambar */
      :root {
        --bg-dark-green: #4d5c38; /* Hijau Tua */
        --bg-medium-green: #7a7a4f; /* Hijau Coklat */
        --text-light: #fff6e8; /* Krem Putih */
        --text-dark: #333333; /* Hitam untuk teks di elemen terang */
        --accent-yellow: #c4c478; /* Kuning Kecoklatan (Aksen Sudut) */
      }

      body {
        background-color: var(--bg-dark-green);
        color: var(--text-light);
        font-family: "Montserrat", sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .custom-header {
        width: 100%;
        padding: 20px 40px;
        display: flex;
        gap: 30px;
        background-color: var(--bg-dark-green);
        z-index: 10;
      }

      .custom-header a {
        color: var(--text-light);
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 400;
        transition: color 0.2s ease-in-out;
      }

      .custom-header a:hover {
        color: var(--accent-yellow);
      }

      /* Gabungkan style body dan pattern */
      .full-screen-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Pastikan di belakang semua konten */
        background-color: var(--bg-dark-green);

        /* --- PERBAIKAN LATAR BELAKANG DAUN --- */
        /* Menggunakan pola yang berbeda dan opacity rendah agar samar */
        /* URL pola daun pisang yang menyerupai referensi gambar Anda */
        background-image: url("image/leaf-pattern.png");
        background-size: 400px; /* Atur ukuran pola */
        background-attachment: fixed;
        opacity: 0.5; /* Nilai Opacity yang Rendah (0.3) untuk menghasilkan tekstur samar */
        /* --- END PERBAIKAN --- */
      }

      /* Override Tailwind untuk font */
      .font-sans {
        font-family: "Montserrat", sans-serif !important;
      }

      /* Header kustom untuk meniru posisi navigasi */
      .custom-header {
        width: 100%;
        padding: 20px 40px;
        display: flex;
        justify-content: flex-start;
        gap: 30px;
        z-index: 10;
      }

      .custom-header a {
        color: var(--text-light);
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 400;
        transition: color 0.2s ease-in-out;
      }

      .custom-header a:hover {
        color: var(--accent-yellow);
      }

      /* Container utama konten */
      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
        z-index: 1;
      }

      .main-title {
        font-size: 4rem;
        font-weight: 700;
        color: var(--accent-yellow);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        margin-bottom: 10px;
      }

      .main-subtitle {
        font-size: 1.2rem;
        color: var(--text-light);
        margin-bottom: 40px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
      }

      /* Area Video/Canvas */
      #container {
        position: relative;
        aspect-ratio: 16 / 9;
        width: 80%;
        max-width: 800px;
        background-color: #888;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        margin-bottom: 40px;
      }

      #canvasOutput,
      #webcam {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #webcam {
        z-index: 9;
        top: -9999px;
        left: -9999px;
      }

      #fpsDisplay {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
        z-index: 20;
      }

      /* Button "Mulai Kamera" */
      #startButton {
        background-color: var(--text-light);
        color: var(--text-dark);
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 5px;
        font-size: 1.1rem;
        transition: background-color 0.3s ease-in-out;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 10px rgba(196, 196, 120, 0.5);
      }

      #startButton:hover {
        background-color: var(--accent-yellow);
        color: var(--text-dark);
      }

      #loadingStatus {
        margin-top: 20px;
        font-size: 1rem;
        color: var(--text-light);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      }

      /* Responsif Sederhana */
      @media (max-width: 768px) {
        .custom-header {
          justify-content: center;
          gap: 15px;
          padding: 15px 20px;
        }

        .main-title {
          font-size: 2.8rem;
        }

        .main-subtitle {
          font-size: 1rem;
        }

        #container {
          width: 95%;
          max-width: unset;
        }

        #startButton {
          padding: 10px 25px;
          font-size: 1rem;
        }
      }

      /* --- FOOTER KONSISTEN --- */
      .custom-footer {
        width: 100%;
        background-color: rgba(77, 92, 56, 0.95);
        padding: 40px 50px 20px 50px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
        margin-top: auto;
      }

      .footer-left {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .footer-logo {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--accent-yellow);
      }

      .footer-logo i {
        font-size: 2.5rem;
        margin-right: 10px;
        color: var(--accent-yellow);
      }

      .footer-social a {
        color: var(--text-light);
        font-size: 1.5rem;
        margin-right: 15px;
        transition: color 0.3s;
      }

      .footer-social a:hover {
        color: var(--accent-yellow);
      }

      .footer-social span {
        display: block;
        max-width: 400px;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 10px;
      }

      .footer-right {
        text-align: right;
      }

      .footer-right a {
        display: block;
        color: var(--text-light);
        text-decoration: none;
        margin-top: 5px;
        font-size: 0.9rem;
      }

      /* Responsif Footer */
      @media (max-width: 768px) {
        .custom-footer {
          flex-direction: column;
          align-items: center;
          text-align: center;
          padding: 30px 20px;
        }

        .footer-left {
          align-items: center;
          margin-bottom: 20px;
        }

        .footer-social {
          margin-bottom: 10px;
        }

        .footer-social span {
          text-align: center;
        }

        .footer-right {
          text-align: center;
        }

        .footer-right a {
          margin-bottom: 5px;
        }
      }
    </style>
  </head>

  <body class="font-sans">
    <div class="full-screen-bg"></div>

    <header class="custom-header">
      <a href="index.html">Beranda</a>
      <a href="about.html">Tentang Kami</a>
      <a href="contact.html">Kontak</a>
    </header>

    <div class="main-content">
      <h1 class="main-title">Spice Lens</h1>
      <p class="main-subtitle">Deteksi rempah real-time berbasis YOLOv8m dsb</p>

      <div id="container">
        <canvas id="canvasOutput"></canvas>
        <video id="webcam" playsinline muted autoplay></video>
        <div id="fpsDisplay">FPS: 0</div>
      </div>

      <button id="startButton">Mulai Kamera</button>

      <div id="loadingStatus">
        Memuat model... (ini mungkin butuh beberapa detik)
      </div>
    </div>

    <footer class="custom-footer">
      <div class="footer-left">
        <div class="footer-logo">
          <i class="fas fa-sun"></i>
          <span>Spice Lens</span>
        </div>
        <div class="footer-social">
          <span>
            Jangan ragu untuk menghubungi kami kapan saja. Kami akan segera
            membalas Anda secepat yang kami bisa!
          </span>
          <br /><br />
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>

      <div class="footer-right">
        <a href="index.html">Beranda</a>
        <a href="about.html">Tentang Kami</a>
        <a href="contact.html">Kontak</a>
      </div>
    </footer>

    <script>
      // --- 1. PENGATURAN & KONSTANTA ---
      const NAMA_KELAS = [
        "Biji Ketumbar",
        "Daun Jeruk",
        "Daun Salam",
        "Jahe",
        "Jinten",
        "Kemiri",
        "Kencur",
        "Kunyit",
        "Lada",
        "Lengkuas",
        "Pala",
        "Serai",
      ];
      const MODEL_INPUT_SIZE = 640;
      const CONFIDENCE_THRESHOLD = 0.5;
      const IOU_THRESHOLD = 0.5;
      const MODEL_PATH = "/best_web_model/model.json";
      const video = document.getElementById("webcam");
      const canvas = document.getElementById("canvasOutput");
      const ctx = canvas.getContext("2d");
      const startButton = document.getElementById("startButton");
      const loadingStatus = document.getElementById("loadingStatus");
      const fpsDisplay = document.getElementById("fpsDisplay");

      let model;
      let isWebcamActive = false;
      let animationFrameId;
      let frameCount = 0;
      const INFERENCE_INTERVAL = 10;
      let lastDetections = [];
      let isInferring = false;
      let fps = 0;
      let lastTime = performance.now();
      let frameTimes = [];
      let lastFrameTime = 0;
      const TARGET_FPS = 30;
      const FRAME_INTERVAL = 1000 / TARGET_FPS;

      // --- 2. FUNGSI UTAMA ---
      async function loadModel() {
        console.log("Memulai memuat model...");
        try {
          model = await tf.loadGraphModel(MODEL_PATH);
          const warmUpTensor = tf.zeros([
            1,
            MODEL_INPUT_SIZE,
            MODEL_INPUT_SIZE,
            3,
          ]);
          await model.executeAsync(warmUpTensor);
          tf.dispose(warmUpTensor);
          console.log("Model berhasil dimuat dan 'dipanaskan'.");
          loadingStatus.innerText = "Model Siap! Klik 'Mulai Kamera'.";
          startButton.innerText = "Mulai Kamera";
          startButton.disabled = false;
        } catch (err) {
          console.error("Gagal memuat model:", err);
          loadingStatus.innerText = "Error: Gagal memuat model.";
        }
      }

      function detectLoop(currentTime) {
        if (!isWebcamActive) return;

        if (currentTime - lastFrameTime < FRAME_INTERVAL) {
          animationFrameId = requestAnimationFrame(detectLoop);
          return;
        }
        lastFrameTime = currentTime;

        const now = performance.now();
        frameTimes.push(now);
        if (frameTimes.length > 60) frameTimes.shift();
        if (frameTimes.length > 1) {
          const delta = (now - frameTimes[0]) / 1000;
          fps = Math.round(frameTimes.length / delta);
        }
        fpsDisplay.textContent = `FPS: ${fps}`;

        if (
          canvas.width !== video.videoWidth ||
          canvas.height !== video.videoHeight
        ) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        }

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        drawDetections(lastDetections);
        frameCount++;

        if (frameCount % INFERENCE_INTERVAL === 0 && !isInferring) {
          isInferring = true;
          setTimeout(async () => {
            await runInference();
            isInferring = false;
          }, 0);
        }

        animationFrameId = requestAnimationFrame(detectLoop);
      }

      async function runInference() {
        const inputTensor = tf.browser
          .fromPixels(video)
          .resizeBilinear([MODEL_INPUT_SIZE, MODEL_INPUT_SIZE])
          .cast("float32")
          .div(255.0)
          .expandDims(0);

        const outputTensor = model.execute(inputTensor);
        const transposedOutput = outputTensor.transpose([0, 2, 1]);

        lastDetections = await processOutput(transposedOutput);

        tf.dispose([inputTensor, outputTensor]);
      }

      async function processOutput(transposedOutput) {
        const numBoxes = transposedOutput.shape[1];
        const numClasses = NAMA_KELAS.length;

        const outputData = await transposedOutput.data();
        tf.dispose(transposedOutput);

        let boxes = [];
        let scores = [];
        let classIndices = [];

        let frameMaxScore = 0;

        for (let i = 0; i < numBoxes; i++) {
          const offset = i * (4 + numClasses);
          const classScores = outputData.slice(
            offset + 4,
            offset + 4 + numClasses
          );

          let maxScore = 0;
          let maxClassIndex = -1;
          for (let j = 0; j < numClasses; j++) {
            if (classScores[j] > maxScore) {
              maxScore = classScores[j];
              maxClassIndex = j;
            }
          }

          if (maxScore > frameMaxScore) {
            frameMaxScore = maxScore;
          }

          if (maxScore > CONFIDENCE_THRESHOLD) {
            const cx = outputData[offset];
            const cy = outputData[offset + 1];
            const w = outputData[offset + 2];
            const h = outputData[offset + 3];
            const y1 = (cy - h / 2) / MODEL_INPUT_SIZE;
            const x1 = (cx - w / 2) / MODEL_INPUT_SIZE;
            const y2 = (cy + h / 2) / MODEL_INPUT_SIZE;
            const x2 = (cx + w / 2) / MODEL_INPUT_SIZE;
            boxes.push([y1, x1, y2, x2]);
            scores.push(maxScore);
            classIndices.push(maxClassIndex);
          }
        }

        console.log("Skor Tertinggi Frame Ini:", frameMaxScore);

        if (boxes.length === 0) {
          return [];
        }

        const boxTensors = tf.tensor2d(boxes);
        const scoreTensors = tf.tensor1d(scores);

        const selectedIndices = await tf.image.nonMaxSuppressionAsync(
          boxTensors,
          scoreTensors,
          100,
          IOU_THRESHOLD,
          CONFIDENCE_THRESHOLD
        );

        const selectedIndicesData = await selectedIndices.data();

        const finalBoxes = [];
        for (let i = 0; i < selectedIndicesData.length; i++) {
          const index = selectedIndicesData[i];
          finalBoxes.push({
            box: boxes[index],
            score: scores[index],
            classIndex: classIndices[index],
          });
        }

        tf.dispose([boxTensors, scoreTensors, selectedIndices]);

        return finalBoxes;
      }

      function drawDetections(boxes) {
        boxes.forEach((boxData) => {
          const [y1_norm, x1_norm, y2_norm, x2_norm] = boxData.box;
          const score = boxData.score;
          const classIndex = boxData.classIndex;
          const label = NAMA_KELAS[classIndex];

          const x = x1_norm * canvas.width;
          const y = y1_norm * canvas.height;
          const w = (x2_norm - x1_norm) * canvas.width;
          const h = (y2_norm - y1_norm) * canvas.height;

          ctx.strokeStyle = "#00FFFF";
          ctx.lineWidth = 3;
          ctx.strokeRect(x, y, w, h);

          ctx.fillStyle = "#00FFFF";
          ctx.font = "18px Arial";
          const text = `${label} (${(score * 100).toFixed(1)}%)`;
          const textWidth = ctx.measureText(text).width;

          ctx.fillRect(x, y, textWidth + 8, 24);
          ctx.fillStyle = "#000000";
          ctx.fillText(text, x + 4, y + 18);
        });
      }

      async function toggleWebcam() {
        if (isWebcamActive) {
          isWebcamActive = false;
          cancelAnimationFrame(animationFrameId);
          const tracks = video.srcObject.getTracks();
          tracks.forEach((track) => track.stop());
          video.srcObject = null;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          startButton.innerText = "Mulai Kamera";
          lastDetections = [];
          frameCount = 0;
          isInferring = false;
          fps = 0;
          frameTimes = [];
          lastFrameTime = 0;
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30, min: 15 },
              },
              audio: false,
            });
            video.srcObject = stream;

            video.onloadedmetadata = async () => {
              try {
                await video.play();
                isWebcamActive = true;
                startButton.innerText = "Hentikan Kamera";
                detectLoop(performance.now());
              } catch (playErr) {
                console.error("Error saat video.play(): ", playErr);
              }
            };
          } catch (err) {
            console.error("Error mengakses webcam:", err);
            alert("Gagal mengakses webcam. Pastikan Anda memberi izin.");
          }
        }
      }

      // --- 3. EVENT LISTENERS ---
      startButton.disabled = true;
      startButton.addEventListener("click", toggleWebcam);
      loadModel();
    </script>
  </body>
</html>
